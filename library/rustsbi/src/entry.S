# =================================================================================
# File: entry.S
# Description: RISC-V M-mode Bootloader with Trap Handling for SBI calls
# This code handles ecall from S-mode (like those from rCore kernel)
# =================================================================================

# ---------------------------------------------------------------------------------
# ä»£ç æ®µï¼šç¨‹åºå…¥å£ç‚¹
# ---------------------------------------------------------------------------------
.section .text.entry, "ax", %progbits
.globl _start

_start:
    # 1. è®¾ç½®æ ˆæŒ‡é’ˆ - è¿™æ˜¯æœ€å…³é”®çš„ç¬¬ä¸€æ­¥ï¼Œä¸ºCä»£ç è¿è¡Œå‡†å¤‡ç¯å¢ƒ
    la sp, _stack_top

    # 2. æ¸…é›¶ .bss æ®µï¼ˆå­˜æ”¾æœªåˆå§‹åŒ–å…¨å±€å˜é‡ï¼‰
    la t0, _bss_start
    la t1, _bss_end
    bgeu t0, t1, 2f
1:
    sd zero, (t0)
    addi t0, t0, 8
    bltu t0, t1, 1b
2:

    # 3. åˆå§‹åŒ–é™·é˜±å¤„ç†æœºåˆ¶
    call trap_init

    # 4. è·³è½¬åˆ°Rustä¸»å‡½æ•°
    call main

    # 5. å®‰å…¨åœæœºï¼ˆå¦‚æœmainå‡½æ•°æ„å¤–è¿”å›ï¼‰
3:
    wfi
    j 3b

# ---------------------------------------------------------------------------------
# ä»£ç æ®µï¼šMæ¨¡å¼é™·é˜±å¤„ç†ç¨‹åº (ç®€åŒ–ç‰ˆæœ¬)
# ---------------------------------------------------------------------------------
.section .text.trap, "ax", %progbits
.globl trap_entry
.align 4

trap_entry:
    # ğŸš¨ å…³é”®ä¿®æ”¹ï¼šå¤§å¹…ç®€åŒ–ä¸Šä¸‹æ–‡ä¿å­˜
    # ä»…åˆ†é…æœ€å°æ ˆç©ºé—´ï¼Œä¿å­˜è°ƒç”¨è€…éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨[1](@ref)
    addi sp, sp, -16
    sd ra, 0(sp)        # ä¿å­˜è¿”å›åœ°å€

    # ğŸš¨ ç›´æ¥è°ƒç”¨Rusté™·é˜±å¤„ç†å‡½æ•°ï¼ˆä¸ä¼ é€’å¤æ‚ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼‰
    call trap_handler

    # ğŸš¨ å¤„ç†å‡½æ•°è¿”å›å€¼(a0)ä½œä¸ºæ–°çš„mepcï¼Œç›´æ¥è®¾ç½®åˆ°mepcå¯„å­˜å™¨
    csrw mepc, a0

    # æ¢å¤å¯„å­˜å™¨å¹¶è¿”å›
    ld ra, 0(sp)
    addi sp, sp, 16
    mret

# ---------------------------------------------------------------------------------
# åˆå§‹åŒ–é™·é˜±å¤„ç†æœºåˆ¶ï¼ˆå¯åœ¨Rustä¸­è°ƒç”¨ï¼‰
# ---------------------------------------------------------------------------------
.globl trap_init
trap_init:
    # è®¾ç½®mtvecå¯„å­˜å™¨æŒ‡å‘é™·é˜±å…¥å£ï¼ˆDirectæ¨¡å¼ï¼‰[2](@ref)
    la t0, trap_entry
    csrw mtvec, t0
    
    # ğŸš¨ å…³é”®ä¿®æ”¹ï¼šå§”æ‰˜S-modeçš„ecallï¼ˆå¼‚å¸¸å·9ï¼‰[3](@ref)
    # è¿™æ ·å†…æ ¸çš„SBIè°ƒç”¨ä¼šç›´æ¥ç”±æ‚¨çš„å›ºä»¶å¤„ç†
    li t0, (1 << 8)   # åŒæ—¶å§”æ‰˜å¼‚å¸¸å·8(U-mode)å’Œ9(S-mode)
    csrw medeleg, t0
    
    ret

# ---------------------------------------------------------------------------------
# æ•°æ®æ®µï¼šæ ˆç©ºé—´å®šä¹‰
# ---------------------------------------------------------------------------------
.section .bss.stack, "aw", %nobits
.align 12           # 4KBå¯¹é½
.global _stack_bottom
_stack_bottom:
.space 32768        # 32KBæ ˆç©ºé—´
.global _stack_top
_stack_top:

# ---------------------------------------------------------------------------------
# BSSæ®µå®šä¹‰ï¼ˆåœ¨é“¾æ¥è„šæœ¬ä¸­é€šå¸¸å·²å®šä¹‰ï¼Œè¿™é‡Œæä¾›ç¬¦å·ï¼‰
# ---------------------------------------------------------------------------------
.section .bss
.global _bss_start
_bss_start:
.global _bss_end
_bss_end: